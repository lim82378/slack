<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper
  PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
  "https://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="FileMapper">
	<!-- DAO에서 호출할 SQL쿼리문의 고유ID는 insertMember임 -->
	<!-- 내 활동 목록 조회 / 채널 초대 기준. -->
	<select id="selectListFileByDm" resultType="com.slack.dto.FileDmChannelDto">
		<![CDATA[
		SELECT f.file_name fileName, 
		d.file_idx fileIdx, 
		d.dm_from dmFrom, 
		d.dm_to dmTo, 
		wu.nickname, TO_CHAR(d.sent_time, 'YYYY-MM-DD HH24:MI:SS') sentTime
		FROM dm d JOIN files f
		ON d.workspace_idx = f.workspace_idx 
		LEFT OUTER JOIN workspace_users wu
		ON d.dm_from = wu.user_id 
		AND f.workspace_idx = wu.workspace_idx
		JOIN file_permission fp
		ON f.file_idx = fp.file_idx
		WHERE (f.file_name LIKE '%' || #{searchKeyword} || '%') AND f.workspace_idx = #{workspaceIdx}
		AND fp.user_id = #{userId}
		]]>
	</select>
	<select id="selectListFileByChannel" resultType="com.slack.dto.FileDmChannelDto">
		SELECT f.file_idx fileIdx, f.file_name fileName,
		c.user_id userId, wu.nickname, TO_CHAR(c.sent_time, 'YYYY-MM-DD HH24:MI:SS') sentTime
		FROM channel_msg c JOIN files f
		ON c.workspace_idx = f.workspace_idx
		LEFT OUTER JOIN workspace_users wu
		ON c.user_id = wu.user_id
		AND f.workspace_idx = wu.workspace_idx
		JOIN file_permission fp
		ON fp.file_idx = f.file_idx
		WHERE (f.file_name LIKE '%' || #{searchKeyword} || '%' )
		AND
		f.workspace_idx = #{workspaceIdx}
		AND
		fp.user_id = #{userId}
	</select>
	<delete id="deleteFileName">
		DELETE FROM files WHERE file_idx =
		#{fileIdx}
	</delete>
	<insert id="insertSharedFile">
		INSERT INTO shared_file ( file_idx, dm_idx,
		channel_idx )
		VALUES (#{fileIdx}, #{dmIdx}, #{channelIdx})
	</insert>
	<select id="selectFileListByPermission" resultType="com.slack.dto.FileWorkspaceUsersDto">
		SELECT F.file_name fileName, F.file_idx fileIdx, F.upload_time uploadTime, WU.nickname, WU.profile_image profileImage 
		FROM files F
		JOIN file_permission FP ON F.file_idx = FP.file_idx
		JOIN workspace_users WU ON FP.user_id = WU.user_id 
		WHERE FP.user_id = #{userId}
		AND WU.workspace_idx = F.workspace_idx 
		ORDER BY F.upload_time DESC
	</select>
	<insert id="insertFiles" parameterType="com.slack.dto.FileWithFilePermissionDto" useGeneratedKeys="true" keyProperty="fileIdx" keyColumn="file_idx">
		INSERT INTO files (file_idx, file_name, workspace_idx, upload_time)
		VALUES (SEQ_FILE_IDX.NEXTVAL,#{fileName}, #{workspaceIdx}, SYSDATE)
	</insert>
	<insert id="insertFilePermission">
		INSERT INTO file_permission (file_idx , user_id)
		VALUES (#{fileIdx}, #{userId})
	</insert>
	<select id="selectFileIdxByName" resultType="java.lang.Integer">
		SELECT file_idx fileIdx
		FROM files 
		WHERE file_name = #{fileName}
	</select>
</mapper>