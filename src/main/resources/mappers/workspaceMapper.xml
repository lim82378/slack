<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper
  PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
  "https://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="WorkspaceMapper">
<!-- 부등호 등등 쓸때 <![CDATA[ ]]> 한줄만 뽑아올때 resultType="java.lang.Integer"-->
	<!-- [MJ] 워크스페이스 이름 조회 -->
	<select id="workspaceNameSelect" resultType="java.lang.String">
		SELECT workspace_name AS workspaceName 
		FROM workspace 
		WHERE workspace_idx = #{workspaceIdx}
	</select>
	
	<!-- [MJ] 워크스페이스 구성원 수 조회 -->
	<select id="workspaceUsersCount" resultType="int">
		SELECT COUNT(user_id) 
		FROM workspace_users 
		WHERE workspace_idx = #{workspaceIdx}
	</select>
	
	<!-- [MJ] 워크스페이스 구성원 이메일, 이름 검색시 -->
	<select id="workspaceUserSearch" resultType="map">
		SELECT nickname, profile_image AS profileImage, user_id AS userId
		FROM workspace_users
		WHERE workspace_idx = #{workspaceIdx} 
		AND (user_id LIKE #{search} || '%' OR nickname LIKE #{search} || '%')
	</select>
	
	<!-- [MJ] users테이블에서 있는지 조회하고, 워크스페이스에 초대하기(디렉터리에 추가) -->
	<select id="usersSelect" resultType="com.slack.dto.UsersDto">
		SELECT user_id AS userId, nickname 
		FROM users 
		WHERE user_id = #{userId}
	</select>
	
	<!-- [MJ] 워크스페이스 사용자 추가 -->
	<insert id="workspaceInsert">
		INSERT INTO workspace_users(workspace_idx, user_id, nickname, profile_image, join_time) 
		VALUES (#{workspaceIdx}, #{userId}, #{nickname},#{profileImage}, sysdate)
	</insert>
	
	<!-- [MJ] 프로필 사진 업로드 -->
	<update id="profileUpload">
		UPDATE workspace_users 
		SET profile_image = #{profileImage} 
		WHERE user_id = #{userId} 
		AND workspace_idx = #{workspaceIdx}
	</update>
	
	<!-- DAO에서 호출할 SQL쿼리문의 고유ID는 insertMember임 -->
	<!-- 내 활동 목록 조회 / 채널 초대 기준. -->
	<!-- <![CDATA[]> 비교/ 부등호 쓰일 때 SQL문 이걸로 감싸주기 -->
	<insert id="insertWorkspace">
		INSERT INTO workspace (workspace_idx,
		workspace_name,user_id)
		VALUES (SEQ_workspace_IDX.NEXTVAL,
		#{workspaceName}, #{userId})
	</insert>
	<insert id="insertWorkspaceUsers">
		INSERT INTO workspace_users (workspace_idx, user_id,
		nickname, join_time, profile_image)
		VALUES (#{workspaceIdx}, #{userId}, #{nickname},
		SYSDATE, #{profileImage, jdbcType=VARCHAR})
	</insert>
	<select id="selectMaxWorkspaceIdx" resultType="java.lang.Integer">
		SELECT MAX(workspace_idx)
		FROM workspace
	</select>
	<insert id="insertInviteCode">
		INSERT INTO workspace_invite(workspace_idx, user_id,
		invite_code)
		VALUES (#{workspaceIdx}, #{userId}, #{inviteCode})
	</insert>
	<select id="selectRecentWorkspaceIdx" resultType="java.lang.Integer">
		SELECT workspace_idx workspaceIdx
		FROM workspace_last
		WHERE user_id = #{userId}
		AND rownum = 1
		ORDER BY reg_date DESC
	</select>
	<select id="selectWorkspaceName" resultType="java.lang.String">
		SELECT workspace_name 
		FROM workspace 
		WHERE workspace_idx = #{workspaceIdx}	
	</select>
	<update id="updateProfileImage">
		UPDATE workspace_users
		SET profile_image = #{profileImage}
		WHERE workspace_idx = #{workspaceIdx} 
		AND user_id = #{userId}
	</update>
	<select id="selectUserIdAndNickNameForMention" resultType="com.slack.dto.WorkspaceUsersMentionDto">
		SELECT user_id userId, nickname
		FROM workspace_users
		WHERE workspace_idx = #{workspaceIdx}
	</select>
	<!-- 워크스페이스 목록조회 -->
	<select id="selectAllWorkspaceInfo" resultType="com.slack.dto.WorkspaceDto">
		SELECT DISTINCT w.workspace_idx AS workspaceIdx, 
		w.workspace_name AS workspaceName, 
		w.user_id AS userId 
		FROM workspace w LEFT JOIN workspace_users wu ON w.workspace_idx = wu.workspace_idx
		WHERE w.user_id = #{userId} OR wu.user_id=#{userId}
	</select>
	<!-- 워크스페이스 닉네임 조회 -->
	<select id="selectUsersNickname" resultType="java.lang.String">
		SELECT nickname FROM users WHERE user_id = #{userId}
	</select>
	<!-- 로그인 후 워크스페이스 체크 -->
	<select id="workspaceListCheck" resultType="int">
		SELECT COUNT(workspace_idx) FROM workspace_users WHERE user_id = #{userId}
	</select>
	<!-- 워크스페이스 프로필 이미지 조회 -->
	<select id="workspaceProfileNameSelect" resultType="java.lang.String">
		SELECT profile_Image AS profileImage FROM workspace_users WHERE workspace_idx = #{workspaceIdx} AND user_id = #{userId}
	</select>
</mapper>